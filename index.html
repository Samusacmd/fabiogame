<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Gioco Phaser Responsive</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      overflow: hidden;
    }
    #game {
      width: 100%;
      height: 100%;
    }
    .panel {
      position: fixed;
      top: 12px;
      left: 12px;
      background: rgba(0, 0, 0, .35);
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 14px;
      color: #fff;
      z-index: 10;
    }
    .touch-ui {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 20;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.js"></script>
</head>
<body>
<div id="game"></div>

<!-- UI touch -->
<div class="touch-ui">
  <div id="joy" style="position:absolute; left:24px; bottom:24px; width:140px; height:140px; pointer-events:auto; touch-action:none;">
    <div style="position:absolute; left:0; top:0; width:140px; height:140px; border-radius:70px; background:rgba(255,255,255,0.1); border:2px solid rgba(255,255,255,0.2);"></div>
    <div id="joy-knob" style="position:absolute; left:55px; top:55px; width:30px; height:30px; border-radius:15px; background:rgba(255,255,255,0.35); border:2px solid rgba(255,255,255,0.6);"></div>
  </div>
  <div id="fire" style="position:absolute; right:24px; bottom:40px; width:96px; height:96px; border-radius:48px; pointer-events:auto; touch-action:none; background:rgba(255,255,255,0.1); border:2px solid rgba(255,255,255,0.25); display:flex; align-items:center; justify-content:center;">
    <span style="font: 600 16px system-ui; color:#eaeaea; user-select:none;">SPARA</span>
  </div>
  <label style="position:absolute; right:24px; bottom:144px; display:flex; gap:8px; align-items:center; pointer-events:auto; user-select:none;">
    <input type="checkbox" id="autofireChk">
    <span style="font: 600 14px system-ui; color:#eaeaea;">Auto-fire</span>
  </label>
  <button id="pauseBtn" style="position:absolute; right:18px; top:12px; width:44px; height:44px; border-radius:22px; pointer-events:auto; touch-action:none; background:rgba(255,255,255,0.12); border:2px solid rgba(255,255,255,0.25); color:#eaeaea; font: 700 16px system-ui;">‚è∏</button>
</div>

<div class="panel"><strong>Comandi:</strong> WASD/frecce, Spazio spara, P pausa, R restart.</div>

<script>
/* ================= VARIABILI GLOBALI ================= */
var W = 900, H = 600;
var cursors, keyW, keyA, keyS, keyD, keySpace, keyP, keyR;
var player, bullets, enemies, lastFired=0, score=0, scoreText, paused=false;

/* controlli touch */
var TOUCH={moveX:0,moveY:0,fire:false,auto:false};
(function(){
  var joy=document.getElementById('joy');
  var knob=document.getElementById('joy-knob');
  var fire=document.getElementById('fire');
  var pauseBtn=document.getElementById('pauseBtn');
  var chk=document.getElementById('autofireChk');
  chk.addEventListener('change',()=>TOUCH.auto=chk.checked);
  var activeId=null,center={x:70,y:70},radius=60;
  function setKnob(dx,dy){knob.style.left=(center.x+dx-15)+'px';knob.style.top=(center.y+dy-15)+'px';}
  function updateFromPoint(cx,cy){
    var r=joy.getBoundingClientRect(),x=cx-r.left,y=cy-r.top,dx=x-center.x,dy=y-center.y,mag=Math.hypot(dx,dy);
    if(mag>radius){dx=dx*radius/mag;dy=dy*radius/mag;}
    setKnob(dx,dy);
    var nx=dx/radius,ny=dy/radius,dz=.15;
    TOUCH.moveX=(Math.abs(nx)<dz)?0:nx;TOUCH.moveY=(Math.abs(ny)<dz)?0:ny;
  }
  function resetStick(){setKnob(0,0);TOUCH.moveX=0;TOUCH.moveY=0;}
  joy.addEventListener('pointerdown',e=>{joy.setPointerCapture(e.pointerId);activeId=e.pointerId;updateFromPoint(e.clientX,e.clientY);e.preventDefault();});
  joy.addEventListener('pointermove',e=>{if(activeId!==e.pointerId)return;updateFromPoint(e.clientX,e.clientY);e.preventDefault();});
  function joyEnd(e){if(activeId!==e.pointerId)return;activeId=null;resetStick();e.preventDefault();}
  joy.addEventListener('pointerup',joyEnd);joy.addEventListener('pointercancel',joyEnd);joy.addEventListener('lostpointercapture',joyEnd);
  fire.addEventListener('pointerdown',e=>{TOUCH.fire=true;fire.style.background='rgba(255,255,255,0.2)';e.preventDefault();});
  fire.addEventListener('pointerup',()=>{TOUCH.fire=false;fire.style.background='rgba(255,255,255,0.1)';});
  pauseBtn.addEventListener('click',()=>{try{if(window.GPAUSE)window.GPAUSE();}catch(_){}});
})();

/* ================= SCENE DI BOOT ================= */
class Boot extends Phaser.Scene {
  constructor(){super('Boot');}
  preload(){
    // tuoi asset originali
    this.load.image('background','assets/background.png');
    this.load.image('player','assets/player.png');
    this.load.image('bullet','assets/bullet.png');
    this.load.image('enemy','assets/enemy.png');
    this.load.audio('shoot','assets/shoot.wav');
    this.load.audio('hit','assets/hit.wav');
  }
  create(){this.scene.start('Main');}
}

/* ================= SCENE DI GIOCO ================= */
class Main extends Phaser.Scene {
  constructor(){super('Main');}
  create(){
    score=0;
    this.add.image(W/2,H/2,'background');
    player=this.physics.add.sprite(W/2,H/2,'player').setCollideWorldBounds(true);
    bullets=this.physics.add.group();
    enemies=this.physics.add.group();
    this.time.addEvent({delay:1000,callback:this.spawnEnemy,callbackScope:this,loop:true});
    scoreText=this.add.text(16,16,'Score: 0',{fontSize:'20px',fill:'#fff'}).setScrollFactor(0);
    cursors=this.input.keyboard.createCursorKeys();
    keyW=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
    keyA=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
    keyS=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S);
    keyD=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D);
    keySpace=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
    keyP=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.P);
    keyR=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.R);
    this.physics.add.overlap(bullets,enemies,this.hitEnemy,null,this);
    this.physics.add.overlap(player,enemies,this.playerHit,null,this);
    this.shootSound=this.sound.add('shoot'); this.hitSound=this.sound.add('hit');
    window.GPAUSE=()=>{paused=!paused; this.physics.world.isPaused=paused;};
  }
  spawnEnemy(){
    var x=Math.random()*W, y=Math.random()*H;
    if(Math.abs(x-player.x)<100) x=(x+200)%W;
    if(Math.abs(y-player.y)<100) y=(y+200)%H;
    enemies.add(this.physics.add.sprite(x,y,'enemy'));
  }
  hitEnemy(bullet,enemy){bullet.destroy();enemy.destroy();this.hitSound.play();score+=10;scoreText.setText('Score: '+score);}
  playerHit(player,enemy){this.scene.restart();}
  update(time){
    if(Phaser.Input.Keyboard.JustDown(keyP)) window.GPAUSE();
    if(Phaser.Input.Keyboard.JustDown(keyR)) this.scene.restart();
    if(paused) return;
    player.setVelocity(0);
    var speed=200;
    if(cursors.left.isDown||keyA.isDown||TOUCH.moveX<-0.1) player.setVelocityX(-speed);
    if(cursors.right.isDown||keyD.isDown||TOUCH.moveX>0.1) player.setVelocityX(speed);
    if(cursors.up.isDown||keyW.isDown||TOUCH.moveY<-0.1) player.setVelocityY(-speed);
    if(cursors.down.isDown||keyS.isDown||TOUCH.moveY>0.1) player.setVelocityY(speed);
    if((keySpace.isDown||TOUCH.fire||TOUCH.auto) && time>lastFired){
      var bullet=bullets.create(player.x,player.y,'bullet');
      if(bullet){bullet.setVelocityY(-400); this.shootSound.play(); lastFired=time+200;}
    }
  }
}

/* ================= AVVIO GIOCO ================= */
new Phaser.Game({
  type: Phaser.AUTO,
  width: W,
  height: H,
  parent: 'game',
  backgroundColor: '#000000',
  physics: {
    default: 'arcade',
    arcade: { gravity: { y: 0 }, debug: false }
  },
  scene: [Boot, Main],
  scale: {
    mode: Phaser.Scale.FIT,          // scala mantenendo proporzioni
    autoCenter: Phaser.Scale.CENTER_BOTH // centra il canvas
  }
});
</script>
</body>
</html>
