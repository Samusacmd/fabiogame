<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Phaser 3 – Preset + Asset personalizzati (modificato: weapon speed + pause/score)</title>
<style>
  html,body{height:100%;margin:0;background:#0b0e14;color:#eaeaea;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
  #game{position:fixed;inset:0;overflow:hidden}
  /* pause menu & scoreboard basic styles (legibili, minimal) */
  .menu-container{
    position:absolute;
    top:50%;left:50%;
    transform:translate(-50%,-50%);
    background:#1a1d24;
    border:2px solid #444;
    border-radius:12px;
    padding:14px;
    box-shadow:0 8px 30px rgba(0,0,0,0.6);
    display:none;
    z-index:1000;
    width:320px;
    text-align:center;
    color:#eee;
  }
  .menu-container h2{margin:6px 0 10px 0;font-size:18px;color:#fff;}
  .menu-container label{font-size:13px;display:block;margin-top:8px;text-align:left;}
  .menu-container input[type=range]{width:100%;margin-top:6px;}
  .menu-container button{margin-top:10px;width:100%;padding:8px;border:none;border-radius:8px;background:#00d9ff;color:#000;font-weight:700;cursor:pointer;}
  .scoreboard{
    position:absolute;
    top:50%;left:50%;
    transform:translate(-50%,-50%);
    background:#111;padding:14px;border-radius:10px;border:2px solid #333;
    display:none;z-index:1001;width:360px;text-align:center;color:#eee;
  }
  .scoreboard h3{margin:6px 0 8px 0;color:#fca311;}
  .scoreboard ul{list-style:none;padding:0;margin:8px 0;max-height:220px;overflow:auto;}
  .scoreboard li{padding:6px 8px;border-bottom:1px solid #223;}
  /* pause button top-right */
  #pauseBtn{
    position: absolute; top:40px; right:12px; z-index:900; border-radius:8px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.06);
    color:#fff; padding:8px 10px; cursor:pointer; font-weight:700;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.js"></script>
</head>
<body>
<div id="game"></div>

<!-- PULSANTE PAUSA IN ALTO A DESTRA -->
<button id="pauseBtn" title="Pausa (P)">⏸</button>

<!-- MENU DI PAUSA -->
<div id="pauseMenu" class="menu-container" role="dialog" aria-hidden="true">
  <h2>Gioco in pausa</h2>
  <label for="musicVolume">Volume Musica</label>
  <input type="range" id="musicVolume" min="0" max="1" step="0.01" value="0.25">
  <label for="sfxVolume">Volume Effetti (SFX)</label>
  <input type="range" id="sfxVolume" min="0" max="1" step="0.01" value="1.00">
  <button id="resumeBtn">Riprendi</button>
  <button id="restartBtn">Riavvia gioco</button>
</div>

<!-- CLASSIFICA -->
<div id="scoreboard" class="scoreboard" role="dialog" aria-hidden="true">
  <h3>Classifica ultime 5 partite</h3>
  <ul id="scoreList"><li>Nessun punteggio</li></ul>
  <button id="restartAfterScore">Gioca di nuovo</button>
</div>

<script>
/* --------------------
  AUDIO + SCORE STORAGE
   - musicVolume: controlla bg_music & boss_music
   - sfxVolume: usato per moltiplicare i volumi SFX (~hit, shoot, boss sounds)
   - persisted in localStorage
   Defaults: music=0.25, sfx=1.0
   -------------------- */
const DEFAULT_MUSIC_VOL = 0.25;
const DEFAULT_SFX_VOL = 1.0;
let musicVolume = parseFloat(localStorage.getItem('musicVolume'));
let sfxVolume = parseFloat(localStorage.getItem('sfxVolume'));
if(isNaN(musicVolume)) musicVolume = DEFAULT_MUSIC_VOL;
if(isNaN(sfxVolume)) sfxVolume = DEFAULT_SFX_VOL;

function saveAudioSettings(){
  localStorage.setItem('musicVolume', String(musicVolume));
  localStorage.setItem('sfxVolume', String(sfxVolume));
}

/* Score storage: keep last 5 scores (unshift newest) */
function saveScore(score){
  try{
    let arr = JSON.parse(localStorage.getItem('scores') || '[]');
    if(!Array.isArray(arr)) arr = [];
    arr.unshift(score);
    if(arr.length>5) arr = arr.slice(0,5);
    localStorage.setItem('scores', JSON.stringify(arr));
  }catch(e){ console.warn('saveScore error',e); }
}
function getScores(){ try{ return JSON.parse(localStorage.getItem('scores')||'[]') || []; }catch(e){return []; } }
function showScoreboardUI(){
  const el = document.getElementById('scoreboard');
  const ul = document.getElementById('scoreList');
  const scores = getScores();
  ul.innerHTML = '';
  if(!scores || scores.length===0){
    ul.innerHTML = '<li>Nessun punteggio</li>';
  } else {
    scores.forEach((s,i)=>{
      ul.innerHTML += `<li>#${i+1}: ${s} punti</li>`;
    });
  }
  el.style.display = 'block';
  el.setAttribute('aria-hidden','false');
}

/* hide UI helpers */
function hidePauseMenu(){
  const pm = document.getElementById('pauseMenu');
  pm.style.display = 'none';
  pm.setAttribute('aria-hidden','true');
}
function hideScoreboard(){
  const sb = document.getElementById('scoreboard');
  sb.style.display = 'none';
  sb.setAttribute('aria-hidden','true');
}

/* --------------------
  Integrazione col tuo gioco (mantengo tutto il codice esistente e aggiungo hooks UI)
  Ho:
   - adattato la creazione di bgMusic/bossMusic per usare `musicVolume`
   - moltiplicato i play SFX con `sfxVolume` (ogni this.sound.play(...) che aveva volume fisso è stato adattato)
   - aggiunto la logica per mostrare/salvare la scoreboard al gameOver
   - aggiunto pausa via DOM (P o pulsante) che mette in pausa la physics/world e i timer e mette in pausa la musica
  -------------------- */

/* ---------- Inizio file di gioco originale (con le integrazioni) ---------- */

var W = (window.innerWidth||800)|0, H = (window.innerHeight||600)|0;
const ASSETS={enabled:true,player:"assets/fornaseiro.png",bullet:"",chaser:"assets/chaser.png",drifter:"assets/drifter.png",sweeper:"assets/sweeper.png",diver:"assets/diver.png",shooter:"assets/shooter.png",heart:"assets/heart.png",boss:"assets/boss.png",explosionSheet:"",explosionFrameW:64,explosionFrameH:64,scales:{player:0.197,bullet:1.0,chaser:0.194,drifter:0.194,sweeper:0.194,diver:0.195,shooter:0.194,heart:0.25,explosion:2.0,},hitbox:{player:{type:'circle',radius:20},bullet:{type:'box',width:8,height:14},enemy:{type:'circle',radius:18},heart:{type:'circle',radius:10},boss:{type:'circle',radius:40}}};

function circleTex(s,key,r,fill,stroke){var g=s.add.graphics();g.fillStyle(fill||0xffffff,1);g.fillCircle(r,r,r);if(stroke){g.lineStyle(3,stroke,1);g.strokeCircle(r,r,r);}g.generateTexture(key,r*2,r*2);g.destroy();}
function rectTex(s,key,w,h,fill,stroke){var g=s.add.graphics();g.fillStyle(fill||0xffffff,1);g.fillRoundedRect(0,0,w,h,Math.min(w,h)*0.2);if(stroke){g.lineStyle(3,stroke,1);g.strokeRoundedRect(0,0,w,h,Math.min(w,h)*0.2);}g.generateTexture(key,w,h);g.destroy();}
function hypot(dx,dy){return Math.sqrt(dx*dx+dy*dy);}

var INPUT={moveX:0,moveY:0,fire:false};
var PLAYER={SPEED:560,FIRE_CD:200,MAX_HP:8,START_HP:5};

// BULLET/WEAPON base settings (modificabili facilmente)
// player bullet base speed and caps
const BULLET_BASE_SPEED = 900;
const BULLET_INC_AFTER_LEVEL = 10;      // dopo questo livello inizia l'incremento
const BULLET_INC_PER_LEVEL = 30;        // quanto aumenta la velocità per livello dopo il livello 10
const BULLET_MAX_SPEED = 1800;         // limite massimo

// enemy bullet speed (opzionale, scalabile)
const ENEMY_BULLET_BASE = 260;
const ENEMY_BULLET_INC_AFTER = 10;
const ENEMY_BULLET_INC_PER_LEVEL = 6;
const ENEMY_BULLET_MAX = 700;

// player fire cooldown progression (minimo)
const PLAYER_FIRECD_BASE = PLAYER.FIRE_CD; // 200
const PLAYER_FIRECD_INC_AFTER = 10;
const PLAYER_FIRECD_DEC_PER_LEVEL = 7;   // riduzione cd (più basso = spara più veloce)
const PLAYER_FIRECD_MIN = 70;

var BULLET={SPEED:BULLET_BASE_SPEED,LIFE:1200};
var ENEMY_BULLET_SPEED = ENEMY_BULLET_BASE;

var DIFF={BASE:1400,MIN:350,STEP_S:10,FACTOR:0.9};

function speedScale(L){return Math.min(1.0,0.45+0.05*L);}
function baseSpeed(t,L){if(t==='CHASER')return 90+L*5;if(t==='DRIFTER')return 55+L*3;if(t==='SWEEPER')return 80+L*4;if(t==='DIVER')return 140+L*6;if(t==='SHOOTER')return 55+L*3;return 80+L*4;}
function capEnemies(L){return Math.min(6+Math.floor(L/2),18);}
function heartChance(L){if(L<=4)return .06;if(L<=8)return .04;return .03;}

/* ---------- Nuova funzione: aggiorna velocità/roaming armi quando cambia il livello ---------- */
function updateWeaponStats(level, scene){
  if(level <= BULLET_INC_AFTER_LEVEL){
    BULLET.SPEED = BULLET_BASE_SPEED;
  } else {
    var extra = (level - BULLET_INC_AFTER_LEVEL) * BULLET_INC_PER_LEVEL;
    BULLET.SPEED = Math.min(BULLET_MAX_SPEED, BULLET_BASE_SPEED + extra);
  }

  if(level <= ENEMY_BULLET_INC_AFTER){
    ENEMY_BULLET_SPEED = ENEMY_BULLET_BASE;
  } else {
    var extraE = (level - ENEMY_BULLET_INC_AFTER) * ENEMY_BULLET_INC_PER_LEVEL;
    ENEMY_BULLET_SPEED = Math.min(ENEMY_BULLET_MAX, ENEMY_BULLET_BASE + extraE);
  }

  if(level <= PLAYER_FIRECD_INC_AFTER){
    PLAYER.FIRE_CD = PLAYER_FIRECD_BASE;
  } else {
    var dec = (level - PLAYER_FIRECD_INC_AFTER) * PLAYER_FIRECD_DEC_PER_LEVEL;
    PLAYER.FIRE_CD = Math.max(PLAYER_FIRECD_MIN, PLAYER_FIRECD_BASE - dec);
  }

  if(scene && scene.levelTxt){
    if(!scene._weaponDebugTxt){
      scene._weaponDebugTxt = scene.add.text(W-12, H-46, '', {fontSize:'12px', color:'#ddd'}).setOrigin(1,0);
    }
    scene._weaponDebugTxt.setText('BS: '+Math.round(BULLET.SPEED)+' | EBS: '+Math.round(ENEMY_BULLET_SPEED)+' | CD: '+Math.round(PLAYER.FIRE_CD));
    scene._weaponDebugTxt.setVisible(false);
  }
}

/* ---------- resto del gioco (con piccole integrazioni audio/UI) ---------- */

var Boot=new Phaser.Class({Extends:Phaser.Scene,initialize:function(){Phaser.Scene.call(this,{key:'boot'});},
preload:function(){
  if(!ASSETS.enabled)return;
  function loadIf(s,k,u){if(u&&u.trim()){s.load.image(k,u);return true;}return false;}
  loadIf(this,'player',ASSETS.player);loadIf(this,'bullet',ASSETS.bullet);loadIf(this,'chaser',ASSETS.chaser);loadIf(this,'drifter',ASSETS.drifter);loadIf(this,'sweeper',ASSETS.sweeper);loadIf(this,'diver',ASSETS.diver);loadIf(this,'shooter',ASSETS.shooter);loadIf(this,'heart',ASSETS.heart);loadIf(this,'boss',ASSETS.boss);
  this.load.image('bg','assets/background.png');
  this.load.audio('hit','sound/hit.mp3');
  this.load.audio('shoot','sound/shoot.mp3');
  this.load.audio('bg_music','sound/background.mp3');
  this.load.audio('boss_music','sound/boss.mp3');
  this.load.audio('boss_explode','sound/boss_explode.mp3');
  this.load.audio('boss_segment_loss','sound/boss_segment.mp3');
  this.load.audio('boss_finish','sound/boss_finish.mp3');
  if(ASSETS.explosionSheet&&ASSETS.explosionSheet.trim()){
    this.load.spritesheet('explosion',ASSETS.explosionSheet,{frameWidth:ASSETS.explosionFrameW||64,frameHeight:ASSETS.explosionFrameH||64});
  }
},
create:function(){if(this.sound&&this.sound.stopAll)this.sound.stopAll();
  if(!this.textures.exists('player'))circleTex(this,'player',16,0x76e4f7,0x0ea5e9);
  if(!this.textures.exists('bullet'))rectTex(this,'bullet',8,14,0xffffff);
  if(!this.textures.exists('chaser'))circleTex(this,'chaser',14,0xff7b7b,0xdb2777);
  if(!this.textures.exists('drifter'))rectTex(this,'drifter',24,16,0xffd166,0xf59e0b);
  if(!this.textures.exists('sweeper'))rectTex(this,'sweeper',18,18,0x60a5fa,0x2563eb);
  if(!this.textures.exists('diver'))circleTex(this,'diver',12,0x34d399,0x059669);
  if(!this.textures.exists('shooter'))circleTex(this,'shooter',18,0xc4b5fd,0x7c3aed);
  if(!this.textures.exists('heart'))circleTex(this,'heart',10,0x22c55e,0x16a34a);
  if(!this.textures.exists('boss'))circleTex(this,'boss',24,0xfca311,0xfb8500);
  if(this.textures.exists('explosion')){this.anims.create({key:'boom',frames:this.anims.generateFrameNumbers('explosion',{start:0,end:7}),frameRate:18,repeat:0});}
  this.scene.start('main');
}});

var Player=new Phaser.Class({Extends:Phaser.Physics.Arcade.Sprite,initialize:function(s,x,y){
  Phaser.Physics.Arcade.Sprite.call(this,s,x,y,'player');s.add.existing(this);s.physics.add.existing(this);
  if(ASSETS.enabled&&ASSETS.player){this.setScale(ASSETS.scales.player||1);}this.setSize(this.displayWidth,this.displayHeight,true);
  this.setCollideWorldBounds(true);this.hp=Math.max(3,PLAYER.START_HP||3);this.lastFired=0;
},damageOnce:function(){var sc=this.scene;if(this.setTintFill){this.setTintFill(0xffa500);if(sc&&sc.time){sc.time.delayedCall(120,()=>{if(this&&this.clearTint)this.clearTint();});}}if(!this.active)return;this.hp=Math.max(0,this.hp-1);this.scene.flash(this);this.scene.events.emit('hp',this.hp);if(this.hp<=0)this.scene.gameOver();}});

var Enemy=new Phaser.Class({Extends:Phaser.Physics.Arcade.Sprite,initialize:function Enemy(s,x,y,tex,type,spd){
  Phaser.Physics.Arcade.Sprite.call(this,s,x,y,tex);s.add.existing(this);s.physics.add.existing(this);
  this.type=type;this.speed=spd;this.hp=1;this.fireCd=1100;this.lastShot=0;
  if(ASSETS.enabled&&ASSETS[tex])this.setScale(ASSETS.scales[tex]||1);this.setSize(this.displayWidth,this.displayHeight,true);
  this.t=0;this.amp=60;this.dir=(Math.random()<.5?-1:1);this.vy=100;
},hit:function(){if(!this.active)return;this.hp-=1;this.scene.flash(this);if(this.hp<=0){if(this.body)this.body.enable=false;this.scene.spawnExplosion(this.x,this.y);this.destroy();}}});

var Boss=new Phaser.Class({Extends:Phaser.Physics.Arcade.Sprite,initialize:function Boss(s,x,y){
  Phaser.Physics.Arcade.Sprite.call(this,s,x,y,'boss');s.add.existing(this);s.physics.add.existing(this);
  var scale=ASSETS.scales.boss;if(!scale){scale=(ASSETS.scales.chaser||0.1)*2.5;}
  if(ASSETS.enabled&&ASSETS.boss){this.setScale(scale);}else{this.setScale(scale);}
  this.setSize(this.displayWidth,this.displayHeight,true);this.dir=1;this.dirY=1;this.fireCd=800;this.lastShot=0;this.hpPerSegment=10;this.segments=2;this.hpRemaining=this.hpPerSegment*this.segments;this.speed=80;this.setCollideWorldBounds(false);this.setBounce(0,0);this.segmentsCurrent=this.segments;this.appearance=1;
},setStats:function(seg,app){this.segments=seg;this.hpRemaining=this.hpPerSegment*seg;this.segmentsCurrent=seg;this.appearance=app;this.speed=60+app*6;this.fireCd=Math.max(400,800-app*40);},
updateBoss:function(t){if(this.alpha!==1)this.setAlpha(1);
  var hw=this.displayWidth*.5,hh=this.displayHeight*.5;
  if(this.x-hw<=0)this.dir=1;if(this.x+hw>=W)this.dir=-1;if(this.y-hh<=0)this.dirY=1;if(this.y+hh>=H)this.dirY=-1;
  this.body.setVelocity(this.dir*this.speed,this.dirY*this.speed*.6);
  if(t>this.lastShot+this.fireCd){
    this.lastShot=t;var base=Phaser.Math.Angle.Between(this.x,this.y,this.scene.player.x,this.scene.player.y);
    var n=Math.min(1+(this.appearance-1),5),spread=15;
    for(var i=0;i<n;i++){var off=(i-(n-1)/2)*spread;var a=base+Phaser.Math.DegToRad(off);this.scene.enemyShoot(this.x,this.y,a);}
  }
},takeHit:function(){if(!this.active)return;this.setAlpha(1);var before=this.segmentsCurrent;this.hpRemaining--;var rem=Math.ceil(this.hpRemaining/this.hpPerSegment);
  if(rem<before){this.segmentsCurrent=rem;if(rem>0){if(this.scene.sound&&this.scene.sound.play){this.scene.sound.play('boss_segment_loss',{volume:1 * sfxVolume});this.setAlpha(1);/*END_GUARD*/}}}
  (()=>{ var sc=this.scene; if(sc&&sc.time){ if(this.setTintFill){ this.setTintFill(0xff4444); sc.time.delayedCall(100,()=>{ if(this && this.clearTint) this.clearTint(); }); } } })();this.scene.updateBossBar(rem);if(this.hpRemaining<=0){this.scene.killBoss();}}});

var Main=new Phaser.Class({Extends:Phaser.Scene,initialize:function(){Phaser.Scene.call(this,{key:'main'});},
init:function(){this.level=1;this.score=0;this.elapsed=0;this.spawnDelay=DIFF.BASE;this.bossActive=false;this.bossCount=0;this.bossSpawnedForLevel=false;this.nextBossMinionSpawn=0;},
create:function(){
  this.bg=this.add.image(W/2,H/2,'bg').setDisplaySize(W,H).setDepth(-2);
  this.dim=this.add.rectangle(W/2,H/2,W,H,0x000000,0.35).setDepth(-1);

  // bgMusic respects the saved musicVolume
  if(this.sound&&this.sound.add){
    this.bgMusic=this.sound.add('bg_music',{loop:true,volume: musicVolume});
    this.bgMusic.play();
    this.events.once(Phaser.Scenes.Events.SHUTDOWN,()=>{if(this.sound&&this.sound.stopAll)this.sound.stopAll();});
  }

  this.bullets=this.physics.add.group();this.enemies=this.physics.add.group();this.pickups=this.physics.add.group();
  this.bossGroup=this.physics.add.group();this.bossBarGroup=this.add.group();this.bossMusic=null;
  this.pointerActive=false;
  this.pointerX=this.game.config.width/2;
  this.pointerY=this.game.config.height-80;
  this.input.on('pointerdown',(p)=>{ this.pointerActive=true; this.pointerX=p.x; this.pointerY=p.y; });
  this.input.on('pointermove',(p)=>{ if(this.pointerActive){ this.pointerX=p.x; this.pointerY=p.y; } });
  this.input.on('pointerup',()=>{ this.pointerActive=false; });

  var k=this.input.keyboard.addKeys('W,A,S,D,UP,DOWN,LEFT,RIGHT,SPACE,SHIFT,CTRL,P,R');this.keys=k;

  // Replace original GPAUSE with UI-aware pause (keeps original behavior but shows menu)
  window.GPAUSE=()=>{ if(this.isGameOver) return; this.togglePause(); };

  this.player=new Player(this,W/2,H-80);
  this.bulletKey='bullet';this.bulletScale=(ASSETS.enabled&&ASSETS.bullet)?(ASSETS.scales.bullet||1):1;

  // aggiorna gli stats delle armi iniziali
  updateWeaponStats(this.level, this);

  this.playerHitCooldown=2000;this.playerIframesUntil=this.time.now;this.paused=false;this.pauseText=null;this.isGameOver=false;

  var self=this;
  this.physics.add.overlap(this.bullets,this.enemies,function(b,e){if(!b.active||!e.active||self.isGameOver)return;b.body.enable=false;b.destroy();if(self.sound&&self.sound.play){self.sound.play('hit',{volume:1 * sfxVolume});}var ex=e.x,ey=e.y;e.hit();if(!e.active){self.addScore(10);if(Phaser.Math.FloatBetween(0,1)<heartChance(self.level))self.dropHeart(ex,ey);}});
  this.physics.add.overlap(this.player,this.enemies,function(){if(self.isGameOver)return;var now=self.time.now;if(now<self.playerIframesUntil)return;self.playerIframesUntil=now+self.playerHitCooldown;self.player.damageOnce();});
  this.physics.add.overlap(this.player,this.pickups,function(p,it){if(!it.active||self.isGameOver)return;it.destroy();if(self.player.hp<PLAYER.MAX_HP){self.player.hp++;self.events.emit('hp',self.player.hp);}self.addScore(25);});
  this.physics.add.overlap(this.bullets,this.bossGroup,function(b,boss){if(!b.active||!boss.active||self.isGameOver)return;b.body.enable=false;b.destroy();boss.takeHit();});
  this.physics.add.overlap(this.player,this.bossGroup,function(){if(self.isGameOver)return;if(!self.bossActive)return;var now=self.time.now;if(now<self.playerIframesUntil)return;self.playerIframesUntil=now+self.playerHitCooldown;self.player.damageOnce();});

  this.scoreTxt=this.add.text(12,H-26,'Score: 0',{fontSize:'16px',color:'#eaeaea'});
  this.levelTxt=this.add.text(W-12,H-26,'Lv 1',{fontSize:'16px',color:'#eaeaea'}).setOrigin(1,0);
  var i;this.hearts=[];for(i=0;i<PLAYER.MAX_HP;i++){this.hearts.push(this.add.image(W-20-i*22,18,'heart').setScale((ASSETS.enabled&&ASSETS.heart)?(ASSETS.scales.heart||1):1));}
  this.events.on('hp',(h)=>{for(i=0;i<this.hearts.length;i++){this.hearts[i].setAlpha(i<h?1:.25);}});

  this.nextSpawn=0;this.time.addEvent({delay:1000,loop:true,callback:()=>{if(this.paused||this.isGameOver)return;this.elapsed++;if(this.elapsed%DIFF.STEP_S===0)this.ramp();}});

  // Pausa: mostra il menu DOM (in alto a destra o P)
  this.input.keyboard.on('keydown-P',()=>{ if(this.isGameOver) return; this.togglePause(); });

  // R per riavviare (mantengo comportamento originale)
  this.input.keyboard.on('keydown-R',()=>{ if(this.sound&&this.sound.stopAll)this.sound.stopAll(); this.physics.world.isPaused=false; this.time.paused=false; try{INPUT.moveX=0;INPUT.moveY=0;INPUT.fire=false;}catch(_){ } this.scene.restart(); });

  this.events.emit('hp',this.player.hp);
  this.physics.world.setBounds(0,0,W,H);

  // add a small on-screen "PAUSA" label? we use DOM pauseBtn instead (see bottom)
  // end create
  // attach helper to scene for toggling pause (used by window.GPAUSE and pauseBtn)
  this.togglePause = function(){
    this.paused = !this.paused;
    this.physics.world.isPaused = this.paused;
    // pause timers: Phaser will continue some timers; keep scene.paused flag used in update loops
    if(this.paused){
      // show DOM pause menu
      document.getElementById('pauseMenu').style.display = 'block';
      document.getElementById('pauseMenu').setAttribute('aria-hidden','false');
      // pause music if playing
      if(this.bgMusic && this.bgMusic.isPlaying) this.bgMusic.pause();
      // also pause bossMusic if active
      if(this.bossMusic && this.bossMusic.isPlaying) this.bossMusic.pause();
      // freeze pointer input to avoid accidental shooting while paused
      this.pointerActiveStateBeforePause = this.pointerActive;
      this.pointerActive = false;
    } else {
      hidePauseMenu();
      if(this.bgMusic && this.bgMusic.isPaused) this.bgMusic.resume();
      if(this.bossMusic && this.bossMusic.isPaused) this.bossMusic.resume();
      // restore pointer
      this.pointerActive = !!this.pointerActiveStateBeforePause;
    }
  }.bind(this);

  // expose restart via DOM
  this.domRestart = function(){
    // hide menus
    hidePauseMenu();
    hideScoreboard();
    if(this.bgMusic && this.bgMusic.isPlaying) this.bgMusic.stop();
    if(this.bossMusic && this.bossMusic.isPlaying) this.bossMusic.stop();
    this.scene.restart();
  }.bind(this);

this.scale.on('resize',(g)=>{
  W=g.width; H=g.height;
  if(this.bg){this.bg.setPosition(W/2,H/2).setDisplaySize(W,H);} 
  if(this.dim){this.dim.setPosition(W/2,H/2).setSize(W,H);} 
  if(this.pauseText&&this.pauseText.active){this.pauseText.setPosition(W/2,H/2);} 
  if(this.scoreTxt){this.scoreTxt.setPosition(12,H-26);} 
  if(this.levelTxt){this.levelTxt.setPosition(W-12,H-26);} 
  if(this.hearts){for(var i=0;i<this.hearts.length;i++){this.hearts[i].setPosition(W-20-i*22,18);}} 
  if(this.physics&&this.physics.world){this.physics.world.setBounds(0,0,W,H);} 
});
},
addScore:function(v){this.score+=v;this.scoreTxt.setText('Score: '+this.score);},
ramp:function(){this.level++;this.levelTxt.setText('Lv '+this.level);var steps=Math.floor(this.level/2);this.spawnDelay=Math.max(DIFF.MIN,Math.floor(DIFF.BASE*Math.pow(0.96,steps)));this.bossSpawnedForLevel=false;
// aggiorna qui le armi quando il livello sale
updateWeaponStats(this.level, this);
},
flash:function(o){this.tweens.add({targets:o,duration:60,repeat:2,alpha:.2,yoyo:true});},
spawnExplosion:function(x,y){if(this.textures.exists('explosion')){var s=this.add.sprite(x,y,'explosion').setScale(ASSETS.scales.explosion||1);s.play('boom');s.on('animationcomplete',()=>s.destroy());}else{var g=this.add.circle(x,y,12,0xfff3c4).setAlpha(0.9);this.tweens.add({targets:g,alpha:0,scale:2,duration:200,onComplete:()=>g.destroy()});}},
dropHeart:function(x,y){var p=this.physics.add.image(x,y,'heart').setScale((ASSETS.enabled&&ASSETS.heart)?(ASSETS.scales.heart||1):1);p.setSize(p.displayWidth,p.displayHeight,true);p.setVelocity(Phaser.Math.Between(-40,40),Phaser.Math.Between(-40,40));p.setDrag(120,120);this.pickups.add(p);this.time.delayedCall(6000,()=>{if(p.active)p.destroy();});},
spawnBullet:function(x,y){if(this.isGameOver)return; if(this.sound&&this.sound.play){this.sound.play('shoot',{volume:0.5 * sfxVolume});}var b=this.physics.add.image(x,y,this.bulletKey).setScale(this.bulletScale);var newW=Math.max(8,b.displayWidth*2),newH=b.displayHeight*4;b.setSize(newW,newH,true);this.bullets.add(b);b.setVelocity(0,-BULLET.SPEED);b.setAngle(+0);b.setDepth(2);this.time.delayedCall(BULLET.LIFE,()=>{if(b&&b.active)b.destroy();});},
spawnEnemy:function(){
  if(this.isGameOver)return;
  if(this.bossActive){var nowTime=this.time.now,L=this.level;if(L<36)return;if(nowTime<this.nextBossMinionSpawn)return;var maxMinions=(L<60)?2:5;var activeMinions=this.enemies.countActive(true);if(activeMinions>=maxMinions)return;this.nextBossMinionSpawn=nowTime+10000;}
  var m=24,x=Phaser.Math.Between(m,W-m),y=m,L=this.level;
  var wC=.28+Math.min(.22,L*.02),wD=.28,wW=.22,wS=(L<4)?0:(L<8?.06:Math.min(.12,.06+(L-8)*.01)),wV=1-(wC+wD+wW+wS),sum=wC+wD+wW+wV+wS;wC/=sum;wD/=sum;wW/=sum;wV/=sum;wS/=sum;
  var r=Math.random(),acc=0,type='CHASER';function pick(w){acc+=w;return r<acc;}if(pick(wC))type='CHASER';else if(pick(wD))type='DRIFTER';else if(pick(wW))type='SWEEPER';else if(pick(wV))type='DIVER';else type='SHOOTER';
  if(this.bossActive){if(L<60&&type==='SHOOTER')type='CHASER';if(L>=60){var sc=this.enemies.getChildren().filter(function(e){return e.type==='SHOOTER';}).length;if(type==='SHOOTER'&&sc>=4)type='CHASER';}}
  var v=Math.floor(baseSpeed(type,L)*speedScale(L));
  var key=(type==='CHASER'?'chaser':type==='DRIFTER'?'drifter':type==='SWEEPER'?'sweeper':type==='DIVER'?'diver':'shooter');
  var e=new Enemy(this,x,y,key,type,v);
  if(type==='DRIFTER'){e.t=0;e.amp=60;e.body.setVelocity(0,e.speed);}
  if(type==='SWEEPER'){e.dir=(Math.random()<.5?-1:1);e.vy=Math.max(70,Math.floor((90+L*3)*speedScale(L)));}
  if(type==='DIVER'){e.lockX=this.player.x;}
  this.enemies.add(e);
},
enemyShoot:function(x,y,ang){
  if(this.isGameOver)return;
  var b=this.physics.add.image(x,y,'bullet').setScale(this.bulletScale).setTint(0xd946ef);
  var newW=Math.max(8,b.displayWidth*2),newH=b.displayHeight*4;b.setSize(newW,newH,true);
  // usa ENEMY_BULLET_SPEED che viene aggiornato da updateWeaponStats
  this.physics.velocityFromRotation(ang, ENEMY_BULLET_SPEED + this.level * 1.0, b.body.velocity);
  this.time.delayedCall(1500,()=>{if(b.active)b.destroy();});
  this.physics.add.overlap(this.player,b,()=>{if(!b.active||this.isGameOver)return;b.body.enable=false;b.destroy();var now=this.time.now;if(now<this.playerIframesUntil)return;this.playerIframesUntil=now+this.playerHitCooldown;this.player.damageOnce();});
},
spawnBoss:function(){
  if(this.isGameOver)return;
  if(this.bossMusic){this.bossMusic.stop();this.bossMusic=null;}
  if(this.bgMusic&&this.bgMusic.isPlaying){this.bgMusic.pause();}
  if(this.sound&&this.sound.add){this.bossMusic=this.sound.add('boss_music',{loop:true,volume: musicVolume});this.bossMusic.play();}
  this.bossActive=true;this.bossCount++;var seg=Math.min(2+(this.bossCount-1),6);
  var boss=new Boss(this,W/2,-80);boss.setStats(seg,this.bossCount);this.bossGroup.add(boss);this.boss=boss;this.createBossBar(seg);
},
createBossBar:function(seg){this.bossBarGroup.clear(true,true);var bw=20,bh=6,sp=4,tot=seg*bw+(seg-1)*sp,start=(W-tot)/2+bw/2;for(var i=0;i<seg;i++){var r=this.add.rectangle(start+i*(bw+sp),6,bw,bh,0xfca311).setOrigin(.5,0);this.bossBarGroup.add(r);}},
updateBossBar:function(rem){var ch=this.bossBarGroup.getChildren();for(var i=0;i<ch.length;i++){ch[i].setVisible(i<rem);} },
killBoss:function(){
  if(!this.bossActive)return;this.bossActive=false;
  if(this.bossMusic){this.bossMusic.stop();this.bossMusic=null;}
  if(this.sound&&this.sound.play){this.sound.play('boss_finish',{volume:1 * sfxVolume});}
  if(this.bgMusic){if(this.bgMusic.isPaused){this.bgMusic.resume();}else if(!this.bgMusic.isPlaying){this.bgMusic.play();}}
  if(this.boss){this.spawnExplosion(this.boss.x,this.boss.y);this.boss.destroy();this.boss=null;}
  this.bossBarGroup.clear(true,true);this.addScore(100*this.level);this.nextBossMinionSpawn=this.time.now+2000;this.bossSpawnedForLevel=true;
},
update:function(t){
  if(this.paused||this.isGameOver)return;
  if(!this.bossActive&&!this.bossSpawnedForLevel&&this.level>=6&&(this.level%6===0)){this.spawnBoss();this.bossSpawnedForLevel=true;}
  if(this.bossActive&&this.boss){this.boss.updateBoss(t);}
  
var dx=0, dy=0, mx=0, my=0;
if(this.pointerActive){
  dx = this.pointerX - this.player.x;
  dy = this.pointerY - this.player.y;
  var len = Math.hypot(dx,dy);
  if(len>0.0001){ mx = dx/len; my = dy/len; }
}
this.player.setVelocity(mx*PLAYER.SPEED, my*PLAYER.SPEED);
var fire = this.pointerActive;
if(fire&&(!this.lastFiredAt||t>this.lastFiredAt+PLAYER.FIRE_CD)){this.lastFiredAt=t;this.spawnBullet(this.player.x,this.player.y-10);}
var L=this.level
,list=this.enemies.getChildren();
  for(var i=0;i<list.length;i++){
    var e=list[i];if(!e.active)continue;
    if(e.type==='CHASER'){var a=Phaser.Math.Angle.Between(e.x,e.y,this.player.x,this.player.y);var vxc=Math.cos(a)*e.speed,vyc=Math.sin(a)*e.speed;var minVy=80*speedScale(L);if(vyc<minVy)vyc=minVy;e.body.setVelocity(vxc,vyc);}
    else if(e.type==='DRIFTER'){e.t+=.02;var drift=Math.sin(e.t)*e.amp;e.body.setVelocity(drift,e.speed);}
    else if(e.type==='SWEEPER'){var vxs=e.dir*e.speed;if(e.x<20)e.dir=1;if(e.x>W-20)e.dir=-1;e.body.setVelocity(vxs,e.vy);}
    else if(e.type==='DIVER'){var dx=e.lockX-e.x;if(Math.abs(dx)>4){var vxd=(dx>0?1:-1)*e.speed;e.body.setVelocity(vxd,e.speed*.6);}else{e.body.setVelocity(0,e.speed*1.1);}}
    else {var dxs=this.player.x-e.x,dys=this.player.y-e.y,d=Math.hypot(dxs,dys);
      if(d>260){var a3=Math.atan2(dys,dxs);e.body.setVelocity(Math.cos(a3)*e.speed,Math.sin(a3)*e.speed);}
      else if(d<200){var a4=Math.atan2(-dys,-dxs);e.body.setVelocity(Math.cos(a4)*e.speed,Math.sin(a4)*e.speed);}
      else {e.body.setVelocity(0,120*speedScale(L));}
      if(t>e.lastShot+Math.max(700,e.fireCd-this.level*18)){e.lastShot=t;this.enemyShoot(e.x, e.y, Math.atan2(dys, dxs));}
    }
    if(e.y>H+40){e.destroy();}
  }
  if(t>this.nextSpawn){
    this.nextSpawn=t+this.spawnDelay;
    var batch=Math.min(1+Math.floor(this.level/5),4),active=this.enemies.countActive(true),room=capEnemies(this.level)-active,toSpawn=Math.max(0,Math.min(batch,room));
    while(toSpawn-- >0)this.spawnEnemy();
  }
},
gameOver:function(){
  if(this.isGameOver) return;
  if(this.sound&&this.sound.stopAll) this.sound.stopAll();
  this.isGameOver=true;
  this.player.setVelocity(0,0);
  if(this.player.body) this.player.body.enable=false;
  this.physics.world.isPaused=true;
  this.time.paused=true;
  if(this.pauseText){ this.pauseText.destroy(); this.pauseText=null; }
  this.add.text(W/2,H/2,'GAME OVER\nScore: '+this.score,{fontSize:'36px',align:'center'}).setOrigin(.5);
  this.add.text(W/2,H/2+80,'R per ricominciare',{fontSize:'16px'}).setOrigin(.5);

  // save score and show scoreboard DOM
  try{ saveScore(this.score); }catch(e){ console.warn('saveScore fail',e); }
  showScoreboardUI();
}});

var game=new Phaser.Game({type:Phaser.AUTO,parent:'game',backgroundColor:'#0b0e14',scale:{mode:Phaser.Scale.RESIZE,autoCenter:Phaser.Scale.CENTER_BOTH,width:W,height:H},physics:{default:'arcade',arcade:{gravity:{y:0},debug:false}},scene:[Boot,Main]});

/* ---------- Fine parte di gioco originale (con le integrazioni) ---------- */

/* --------------------
  DOM handlers for pause UI, volume sliders and scoreboard buttons
  - pauseBtn toggles pause (same as P)
  - sliders update musicVolume / sfxVolume and save to localStorage
  - resumeBtn hides menu and resumes game
  - restartBtn restarts the scene
  - restartAfterScore restarts from scoreboard
  -------------------- */

const pauseBtn = document.getElementById('pauseBtn');
const pauseMenu = document.getElementById('pauseMenu');
const resumeBtn = document.getElementById('resumeBtn');
const restartBtn = document.getElementById('restartBtn');
const musicSlider = document.getElementById('musicVolume');
const sfxSlider = document.getElementById('sfxVolume');
const restartAfterScore = document.getElementById('restartAfterScore');

musicSlider.value = musicVolume;
sfxSlider.value = sfxVolume;

pauseBtn.addEventListener('click', ()=>{
  const sc = game.scene.keys['main'];
  if(!sc) return;
  sc.togglePause();
});

// resume button
resumeBtn.addEventListener('click', ()=>{
  const sc = game.scene.keys['main'];
  if(!sc) return;
  sc.togglePause();
});

// restart from pause menu
restartBtn.addEventListener('click', ()=>{
  const sc = game.scene.keys['main'];
  if(!sc) return;
  hidePauseMenu();
  // stop music to avoid overlap
  try{ if(sc.bgMusic && sc.bgMusic.isPlaying) sc.bgMusic.stop(); }catch(e){}
  try{ if(sc.bossMusic && sc.bossMusic.isPlaying) sc.bossMusic.stop(); }catch(e){}
  sc.scene.restart();
});

// restart from scoreboard
restartAfterScore.addEventListener('click', ()=>{
  hideScoreboard();
  const sc = game.scene.keys['main'];
  if(sc){
    try{ if(sc.bgMusic && sc.bgMusic.isPlaying) sc.bgMusic.stop(); }catch(e){}
    try{ if(sc.bossMusic && sc.bossMusic.isPlaying) sc.bossMusic.stop(); }catch(e){}
  }
  // restart scene cleanly
  game.scene.stop('main');
  game.scene.start('main');
});

// music slider
musicSlider.addEventListener('input', (ev)=>{
  musicVolume = parseFloat(ev.target.value);
  saveAudioSettings();
  // update current bgMusic & bossMusic volumes
  const sc = game.scene.keys['main'];
  if(sc){
    if(sc.bgMusic) sc.bgMusic.setVolume(musicVolume);
    if(sc.bossMusic) sc.bossMusic.setVolume(musicVolume);
  }
});

// sfx slider
sfxSlider.addEventListener('input', (ev)=>{
  sfxVolume = parseFloat(ev.target.value);
  saveAudioSettings();
  // sfxVolume takes effect on subsequent this.sound.play calls (we multiplied plays by sfxVolume)
});

// hide pause if clicking outside (small UX)
window.addEventListener('keydown', (e)=>{
  if(e.key==='Escape'){
    // escape closes pause menu if open
    const sc = game.scene.keys['main'];
    if(sc && sc.paused){
      sc.togglePause();
    }
  }
});

// ensure UI hidden initially
hidePauseMenu();
hideScoreboard();

</script>
</body>
</html>
