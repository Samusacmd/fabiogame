<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phaser 3 – Gioco Responsive con Asset</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #0b0e14;
      color: #eaeaea;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
    }
    #game {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    .panel {
      position: fixed;
      top: 12px;
      left: 12px;
      background: rgba(0, 0, 0, .35);
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 14px;
      backdrop-filter: blur(6px);
      z-index: 10;
    }
    .touch-ui {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 20;
      padding: 0 env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.js"></script>
</head>
<body>
  <div id="game"></div>

  <!-- UI touch -->
  <div class="touch-ui">
    <div id="joy" style="position:absolute; left:24px; bottom:24px; width:140px; height:140px; pointer-events:auto; touch-action:none;">
      <div style="position:absolute; left:0; top:0; width:140px; height:140px; border-radius:70px; background:rgba(255,255,255,0.1); border:2px solid rgba(255,255,255,0.2);"></div>
      <div id="joy-knob" style="position:absolute; left:55px; top:55px; width:30px; height:30px; border-radius:15px; background:rgba(255,255,255,0.35); border:2px solid rgba(255,255,255,0.6);"></div>
    </div>
    <div id="fire" style="position:absolute; right:24px; bottom:40px; width:96px; height:96px; border-radius:48px; pointer-events:auto; touch-action:none; background:rgba(255,255,255,0.1); border:2px solid rgba(255,255,255,0.25); display:flex; align-items:center; justify-content:center;">
      <span style="font: 600 16px system-ui; color:#eaeaea; user-select:none;">SPARA</span>
    </div>
    <label style="position:absolute; right:24px; bottom:144px; display:flex; gap:8px; align-items:center; pointer-events:auto; user-select:none;">
      <input type="checkbox" id="autofireChk">
      <span style="font: 600 14px system-ui; color:#eaeaea;">Auto-fire</span>
    </label>
    <button id="pauseBtn" style="position:absolute; right:18px; top:12px; width:44px; height:44px; border-radius:22px; pointer-events:auto; touch-action:none; background:rgba(255,255,255,0.12); border:2px solid rgba(255,255,255,0.25); color:#eaeaea; font: 700 16px system-ui;">⏸</button>
  </div>

  <div class="panel"><strong>Comandi:</strong> WASD/frecce, Spazio spara, P pausa, R restart.</div>

  <script>
  var TOUCH = { moveX:0, moveY:0, fire:false, auto:false };
  (function(){
    var joy = document.getElementById('joy');
    var knob = document.getElementById('joy-knob');
    var fire = document.getElementById('fire');
    var pauseBtn = document.getElementById('pauseBtn');
    var chk = document.getElementById('autofireChk');
    chk.addEventListener('change', ()=>TOUCH.auto = chk.checked);
    var activeId = null, center = {x:70, y:70}, radius = 60;
    function setKnob(dx,dy){ knob.style.left = (center.x + dx - 15) + 'px'; knob.style.top = (center.y + dy - 15) + 'px'; }
    function updateFromPoint(cx,cy){
      var r = joy.getBoundingClientRect(), x = cx - r.left, y = cy - r.top, dx = x - center.x, dy = y - center.y, mag = Math.hypot(dx,dy);
      if (mag > radius) {
        dx = dx * radius / mag;
        dy = dy * radius / mag;
      }
      setKnob(dx,dy);
      var nx = dx / radius, ny = dy / radius, dz = .15;
      TOUCH.moveX = (Math.abs(nx) < dz) ? 0 : nx;
      TOUCH.moveY = (Math.abs(ny) < dz) ? 0 : ny;
    }
    function resetStick(){ setKnob(0,0); TOUCH.moveX = 0; TOUCH.moveY = 0; }
    joy.addEventListener('pointerdown', e => { joy.setPointerCapture(e.pointerId); activeId = e.pointerId; updateFromPoint(e.clientX, e.clientY); e.preventDefault(); });
    joy.addEventListener('pointermove', e => { if (activeId !== e.pointerId) return; updateFromPoint(e.clientX, e.clientY); e.preventDefault(); });
    function joyEnd(e){ if (activeId !== e.pointerId) return; activeId = null; resetStick(); e.preventDefault(); }
    joy.addEventListener('pointerup', joyEnd);
    joy.addEventListener('pointercancel', joyEnd);
    joy.addEventListener('lostpointercapture', joyEnd);
    fire.addEventListener('pointerdown', e => { TOUCH.fire = true; fire.style.background = 'rgba(255,255,255,0.2)'; e.preventDefault(); });
    fire.addEventListener('pointerup', e => { TOUCH.fire = false; fire.style.background = 'rgba(255,255,255,0.1)'; e.preventDefault(); });
    pauseBtn.addEventListener('click', e => { try { if (window.GPAUSE) window.GPAUSE(); } catch (_) {} e.preventDefault(); });
    ['touchstart','touchmove','touchend'].forEach(t => document.addEventListener(t, ev => { ev.preventDefault(); }, { passive:false }));
  })();
  </script>

  <script>
  // CONFIGURAZIONE
  var W = 900, H = 600;

  // Scene di Boot con caricamento asset
  class Boot extends Phaser.Scene {
    constructor(){ super('Boot'); }
    preload(){
      // Carica immagini
      this.load.image('player', 'assets/fornaseiro.png');
      this.load.image('chaser', 'assets/chaser.png');
      this.load.image('drifter', 'assets/drifter.png');
      this.load.image('sweeper', 'assets/sweeper.png');
      this.load.image('diver', 'assets/diver.png');
      this.load.image('shooter', 'assets/shooter.png');
      this.load.image('heart', 'assets/heart.png');
      this.load.image('boss', 'assets/boss.png');
      this.load.image('bg', 'assets/background.png');
      // Se hai spritesheet per le esplosioni
      this.load.spritesheet('explosion', 'assets/explosionSheet.png', { frameWidth: 64, frameHeight: 64 });

      // Carica suoni
      this.load.audio('hit', 'sound/hit.mp3');
      this.load.audio('shoot', 'sound/shoot.mp3');
      this.load.audio('bg_music', 'sound/background.mp3');
      this.load.audio('boss_music', 'sound/boss.mp3');
      this.load.audio('boss_hit', 'sound/boss_hit.mp3');
      this.load.audio('boss_explode', 'sound/boss_explode.mp3');
      this.load.audio('boss_segment_loss', 'sound/boss_segment.mp3');
      this.load.audio('boss_finish', 'sound/boss_finish.mp3');
    }
    create(){
      // Se manca qualche texture, fallback generico (opzionale)
      this.scene.start('Main');
    }
  }

  class Main extends Phaser.Scene {
    constructor(){ super('Main'); }
    init(){
      this.level = 1;
      this.score = 0;
      this.elapsed = 0;
      this.spawnDelay = 1400;
      this.bossActive = false;
      this.bossCount = 0;
      this.bossSpawnedForLevel = false;
      this.nextBossMinionSpawn = 0;
    }
    create(){
      // sfondo
      this.add.image(W/2, H/2, 'bg').setDisplaySize(W, H).setDepth(-2);
      this.add.rectangle(W/2, H/2, W, H, 0x000000, 0.35).setDepth(-1);

      // musica di sfondo
      this.bgMusic = this.sound.add('bg_music', { loop: true, volume: 0.25 });
      this.bgMusic.play();

      // gruppi
      this.bullets = this.physics.add.group();
      this.enemies = this.physics.add.group();
      this.pickups = this.physics.add.group();
      this.bossGroup = this.physics.add.group();
      this.bossBarGroup = this.add.group();

      // input tastiera
      this.keys = this.input.keyboard.addKeys('W,A,S,D,UP,DOWN,LEFT,RIGHT,SPACE,P,R');

      // player
      this.player = this.physics.add.sprite(W/2, H-80, 'player');
      this.player.setCollideWorldBounds(true);
      this.player.hp = 3;
      this.lastFired = 0;

      // HUD punteggio / livello
      this.scoreTxt = this.add.text(12, H-26, 'Score: 0', { fontSize:'16px', color:'#eaeaea' });
      this.levelTxt = this.add.text(W-12, H-26, 'Lv 1', { fontSize:'16px', color:'#eaeaea' }).setOrigin(1,0);

      // cuori
      this.hearts = [];
      for (let i = 0; i < 5; i++){
        let h = this.add.image(W-20 - i*22, 18, 'heart');
        this.hearts.push(h);
      }
      this.events.on('hp', h => {
        for (let i = 0; i < this.hearts.length; i++){
          this.hearts[i].setAlpha(i < h ? 1 : 0.25);
        }
      });

      // collisioni
      this.physics.add.overlap(this.bullets, this.enemies, (b, e) => {
        if (!b.active || !e.active) return;
        b.destroy();
        e.destroy();
        this.sound.play('hit');
        this.score += 10;
        this.scoreTxt.setText('Score: ' + this.score);
      });

      this.physics.add.overlap(this.player, this.enemies, () => {
        this.scene.restart();
      });

      // spawn nemici continuo
      this.nextSpawn = 0;

      this.time.addEvent({
        delay: 1000,
        loop: true,
        callback: () => {
          this.elapsed++;
          if (this.elapsed % 10 === 0) {
            this.spawnDelay = Math.max(350, Math.floor(1400 * Math.pow(0.96, this.level/2)));
          }
        }
      });

      window.GPAUSE = () => {
        this.paused = !this.paused;
        this.physics.world.isPaused = this.paused;
        if (this.paused) {
          this.pauseText = this.add.text(W/2, H/2, 'PAUSA', { fontSize:'32px', color:'#fff' }).setOrigin(0.5);
        } else {
          if (this.pauseText) this.pauseText.destroy();
        }
      };
    }
    update(time){
      if (Phaser.Input.Keyboard.JustDown(this.keys.P)) {
        window.GPAUSE();
      }
      if (Phaser.Input.Keyboard.JustDown(this.keys.R)) {
        this.scene.restart();
      }
      if (this.paused) return;

      // movimento player
      let vx = 0, vy = 0;
      if (this.keys.A.isDown || this.keys.LEFT.isDown || TOUCH.moveX < -0.1) vx = -1;
      if (this.keys.D.isDown || this.keys.RIGHT.isDown || TOUCH.moveX > 0.1) vx = 1;
      if (this.keys.W.isDown || this.keys.UP.isDown || TOUCH.moveY < -0.1) vy = -1;
      if (this.keys.S.isDown || this.keys.DOWN.isDown || TOUCH.moveY > 0.1) vy = 1;
      this.player.setVelocity(vx * 260, vy * 260);

      // sparo
      if ((this.keys.SPACE.isDown || TOUCH.fire || TOUCH.auto) && time > this.lastFired + 200) {
        this.lastFired = time;
        let b = this.bullets.create(this.player.x, this.player.y - 10, 'bullet');
        if (b) {
          b.setVelocity(0, -640);
          this.sound.play('shoot');
        }
      }

      // spawn nemici
      if (time > this.nextSpawn) {
        this.nextSpawn = time + this.spawnDelay;
        this.spawnEnemy();
      }
    }
    spawnEnemy(){
      let x = Phaser.Math.Between(20, W-20);
      let y = Phaser.Math.Between(20, H/2);
      let types = ['chaser','drifter','sweeper','diver','shooter'];
      let key = Phaser.Utils.Array.GetRandom(types);
      let e = this.enemies.create(x, y, key);
      e.type = key;
      // puoi aggiungere velocità, comportamento a seconda del tipo
    }
  }

  // creazione del gioco
  new Phaser.Game({
    type: Phaser.AUTO,
    width: W,
    height: H,
    parent: 'game',
    backgroundColor: '#0b0e14',
    physics: {
      default: 'arcade',
      arcade: { gravity: { y: 0 }, debug: false }
    },
    scene: [Boot, Main],
    scale: {
      mode: Phaser.Scale.FIT,
      autoCenter: Phaser.Scale.CENTER_BOTH
    }
  });
  </script>
</body>
</html>
